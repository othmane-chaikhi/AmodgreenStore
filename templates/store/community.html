{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Communaut√© - AmodGreen{% endblock %}

{% block content %}


<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-stone-800 mb-4">
            üë• Communaut√© AmodGreen
        </h1>
        <p class="text-xl text-stone-600 max-w-3xl mx-auto">
            Partagez vos exp√©riences, d√©couvrez les t√©moignages de nos clients 
            et rejoignez notre communaut√© de passionn√©s de produits naturels.
        </p>
    </div>
    
    <!-- Formulaire de nouveau post (si connect√©) -->
    {% if user.is_authenticated %}
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-lg font-semibold text-stone-800 mb-4">
                <i class="fas fa-pen mr-2 text-olive-600"></i>
                Partager votre exp√©rience
            </h3>
            
            <form method="post" action="{% url 'create_post' %}">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="{{ post_form.title.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-2">
                            {{ post_form.title.label }}
                        </label>
                        {{ post_form.title }}
                    </div>
                    
                    <div>
                        <label for="{{ post_form.post_type.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-2">
                            {{ post_form.post_type.label }}
                        </label>
                        {{ post_form.post_type }}
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="{{ post_form.product.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-2">
                        {{ post_form.product.label }}
                    </label>
                    {{ post_form.product }}
                </div>
                
                <div class="mb-4">
                    <label for="{{ post_form.content.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-2">
                        {{ post_form.content.label }}
                    </label>
                    {{ post_form.content }}
                </div>
                
                <div class="flex justify-between items-center">
                    <p class="text-sm text-stone-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Votre message sera publi√© apr√®s mod√©ration.
                    </p>
                    
                    <button type="submit" 
                            class="bg-olive-600 hover:bg-olive-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Publier
                    </button>
                </div>
            </form>
        </div>
    {% else %}
        <div class="bg-sage-50 border border-sage-200 rounded-lg p-6 mb-8 text-center">
            <h3 class="font-semibold text-sage-800 mb-2">
                <i class="fas fa-user-plus mr-2"></i>
                Rejoignez notre communaut√© !
            </h3>
            <p class="text-sage-700 mb-4">
                Connectez-vous ou inscrivez-vous pour partager vos exp√©riences et interagir avec la communaut√©.
            </p>
            <div class="flex justify-center gap-4">
                <a href="{% url 'login' %}" 
                   class="bg-sage-600 hover:bg-sage-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    Se connecter
                </a>
                <a href="{% url 'register' %}" 
                   class="bg-olive-600 hover:bg-olive-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    S'inscrire
                </a>
            </div>
        </div>
    {% endif %}
    
    <!-- Filtres -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-8">
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-sm font-medium text-stone-700 mr-2">Filtrer par type :</span>
            
            <a href="{% url 'community' %}" 
               class="px-3 py-1 rounded-full text-sm font-medium transition-colors {% if not current_type %}bg-olive-600 text-white{% else %}bg-stone-200 text-stone-700 hover:bg-stone-300{% endif %}">
                Tous
            </a>
            
            <a href="{% url 'community' %}?type=review" 
               class="px-3 py-1 rounded-full text-sm font-medium transition-colors {% if current_type == 'review' %}bg-olive-600 text-white{% else %}bg-stone-200 text-stone-700 hover:bg-stone-300{% endif %}">
                <i class="fas fa-star mr-1"></i>Avis produits
            </a>
            
            <a href="{% url 'community' %}?type=testimonial" 
               class="px-3 py-1 rounded-full text-sm font-medium transition-colors {% if current_type == 'testimonial' %}bg-olive-600 text-white{% else %}bg-stone-200 text-stone-700 hover:bg-stone-300{% endif %}">
                <i class="fas fa-heart mr-1"></i>T√©moignages
            </a>
            
            <a href="{% url 'community' %}?type=discussion" 
               class="px-3 py-1 rounded-full text-sm font-medium transition-colors {% if current_type == 'discussion' %}bg-olive-600 text-white{% else %}bg-stone-200 text-stone-700 hover:bg-stone-300{% endif %}">
                <i class="fas fa-comments mr-1"></i>Discussions
            </a>
        </div>
    </div>
    
    <!-- Posts de la communaut√© -->
    <div class="space-y-6">
        {% for post in page_obj %}
            <article id="post-{{ post.id }}" class="bg-white rounded-lg shadow-md p-6">
                <!-- En-t√™te du post -->
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-olive-600 rounded-full flex items-center justify-center text-white font-semibold text-lg">
                            {{ post.author.first_name.0|default:post.author.username.0 }}
                        </div>
                        <div class="ml-4">
                            <div class="font-semibold text-stone-800">
                                {{ post.author.first_name|default:post.author.username }}
                                {% if post.author.city %}
                                    <span class="text-sm text-stone-500">- {{ post.author.city }}</span>
                                {% endif %}
                            </div>
                            <div class="text-sm text-stone-500">
                                {{ post.created_at|date:"d M Y √† H:i" }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Type de post -->
                    <div class="flex items-center space-x-2">
                        {% if post.post_type == 'review' %}
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                                <i class="fas fa-star mr-1"></i>Avis
                            </span>
                        {% elif post.post_type == 'testimonial' %}
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">
                                <i class="fas fa-heart mr-1"></i>T√©moignage
                            </span>
                        {% else %}
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                <i class="fas fa-comments mr-1"></i>Discussion
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Contenu du post -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold text-stone-800 mb-2">{{ post.title }}</h3>
                    <p class="text-stone-600 leading-relaxed">{{ post.content|linebreaks }}</p>
                    
                    {% if post.product %}
                        <div class="mt-3 p-3 bg-stone-50 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-leaf mr-2 text-olive-600"></i>
                                <span class="text-sm text-stone-700">
                                    √Ä propos de : 
                                    <a href="{{ post.product.get_absolute_url }}" 
                                       class="font-medium text-olive-600 hover:text-olive-700">
                                        {{ post.product.name }}
                                    </a>
                                </span>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Actions et commentaires -->
                <div class="border-t border-stone-200 pt-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-sm text-stone-500">
                            <i class="fas fa-comment mr-1"></i>
                            {{ post.comments.count }} commentaire{{ post.comments.count|pluralize }}
                        </div>
                        
                        {% if user.is_authenticated %}
                            <button onclick="toggleCommentForm({{ post.id }})" 
                                    class="text-olive-600 hover:text-olive-700 text-sm font-medium">
                                <i class="fas fa-reply mr-1"></i>R√©pondre
                            </button>
                        {% endif %}
                    </div>
                    
                    <!-- Commentaires existants -->
                    {% for comment in post.comments.all %}
                        {% if comment.is_approved %}
                            <div class="bg-stone-50 rounded-lg p-3 mb-3">
                                <div class="flex items-center mb-2">
                                    <div class="w-8 h-8 bg-sage-600 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                        {{ comment.author.first_name.0|default:comment.author.username.0 }}
                                    </div>
                                    <div class="ml-2">
                                        <div class="font-medium text-stone-800 text-sm">
                                            {{ comment.author.first_name|default:comment.author.username }}
                                        </div>
                                        <div class="text-xs text-stone-500">
                                            {{ comment.created_at|date:"d M Y √† H:i" }}
                                        </div>
                                    </div>
                                </div>
                                <p class="text-stone-600 text-sm">{{ comment.content|linebreaks }}</p>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Formulaire de commentaire -->
                    {% if user.is_authenticated %}
                        <div id="comment-form-{{ post.id }}" class="hidden mt-4 p-4 bg-stone-50 rounded-lg">
                            <form method="post" action="{% url 'add_comment' post.id %}">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <textarea name="content" rows="3" 
                                              placeholder="Votre commentaire..." 
                                              class="w-full px-3 py-2 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-olive-500"></textarea>
                                </div>
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-stone-500">
                                        Votre commentaire sera publi√© apr√®s mod√©ration.
                                    </p>
                                    <button type="submit" 
                                            class="bg-olive-600 hover:bg-olive-700 text-white px-4 py-2 rounded font-medium text-sm transition-colors">
                                        <i class="fas fa-paper-plane mr-1"></i>Commenter
                                    </button>
                                </div>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </article>
        {% empty %}
            <div class="text-center py-16">
                <i class="fas fa-comments text-6xl text-stone-300 mb-6"></i>
                <h3 class="text-2xl font-semibold text-stone-600 mb-4">Aucun message pour le moment</h3>
                <p class="text-stone-500 mb-6">
                    {% if current_type %}
                        Aucun message de ce type n'a √©t√© publi√©.
                    {% else %}
                        Soyez le premier √† partager votre exp√©rience !
                    {% endif %}
                </p>
                {% if not user.is_authenticated %}
                    <a href="{% url 'register' %}" 
                       class="bg-olive-600 hover:bg-olive-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        Rejoindre la communaut√©
                    </a>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <div class="mt-12 flex justify-center">
            <nav class="flex space-x-2">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if current_type %}&type={{ current_type }}{% endif %}" 
                       class="bg-white border border-stone-300 text-stone-500 hover:bg-stone-50 px-3 py-2 rounded-l-lg transition-colors">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}" 
                       class="bg-white border border-stone-300 text-stone-500 hover:bg-stone-50 px-3 py-2 transition-colors">
                        <i class="fas fa-angle-left"></i>
                    </a>
                {% endif %}
                
                <span class="bg-olive-600 text-white px-4 py-2">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if current_type %}&type={{ current_type }}{% endif %}" 
                       class="bg-white border border-stone-300 text-stone-500 hover:bg-stone-50 px-3 py-2 transition-colors">
                        <i class="fas fa-angle-right"></i>
                    </a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if current_type %}&type={{ current_type }}{% endif %}" 
                       class="bg-white border border-stone-300 text-stone-500 hover:bg-stone-50 px-3 py-2 rounded-r-lg transition-colors">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                {% endif %}
            </nav>
        </div>
    {% endif %}
</div>

<script>
function toggleCommentForm(postId) {
    const form = document.getElementById(`comment-form-${postId}`);
    form.classList.toggle('hidden');
    
    if (!form.classList.contains('hidden')) {
        const textarea = form.querySelector('textarea');
        textarea.focus();
    }
}
</script>
{% endblock %}